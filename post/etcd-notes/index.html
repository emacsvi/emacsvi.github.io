<!doctype html>
<html lang="zh-CN">
<head>

    <meta charset="utf-8">
    <meta name="generator" content="Hugo 0.54.0" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <title>etcd备忘 | 李伟的博客</title>
    <meta property="og:title" content="etcd备忘 - 李伟的博客">
    <meta property="og:type" content="article">
        
    <meta property="article:published_time" content="2019-03-13T00:00:00&#43;08:00">
        
        
    <meta property="article:modified_time" content="2019-03-13T00:00:00&#43;08:00">
        
    <meta name="Keywords" content="golang,go语言,go语言笔记,区块链,博客,项目管理,python,软件架构">
    <meta name="description" content="ectd">
        
    <meta name="author" content="emacsvi">
    <meta property="og:url" content="http://emacsvi.com/post/etcd-notes/">
    <link rel="shortcut icon" href="/favicon.ico" type="image/x-icon">

    <link rel="stylesheet" href="/css/normalize.css">
    
        <link rel="stylesheet" href="/css/prism.css">
    
    <link rel="stylesheet" href="/css/style.css">
    <script type="text/javascript" src="//cdn.bootcss.com/jquery/3.2.1/jquery.min.js"></script>
    
    
    <script async src="https://www.googletagmanager.com/gtag/js?id=UA-129687838-1"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());

      gtag('config', 'UA-129687838-1');
    </script>


    


    
    
</head>

<body>
<header id="header" class="clearfix">
    <div class="container">
        <div class="col-group">
            <div class="site-name ">
                
                    <a id="logo" href="http://emacsvi.com">
                        李伟的博客
                    </a>
                
                <p class="description">主要专注于区块链、Go语言(golang)、Python、C语言、后端服务架构</p>
            </div>
            <div>
                <nav id="nav-menu" class="clearfix">
                    <a class="current" href="http://emacsvi.com">首页</a>
                    
                    <a  href="http://emacsvi.com/archives/" title="归档">归档</a>
                    
                    <a  href="http://emacsvi.com/about/" title="关于">关于</a>
                    
                    <a  href="http://emacsvi.com/travel/" title="旅行">旅行</a>
                    
                </nav>
            </div>
        </div>
    </div>
</header>


<div id="body">
    <div class="container">
        <div class="col-group">

            <div class="col-8" id="main">
                <div class="res-cons">
                    <article class="post">
                        <header>
                            <h1 class="post-title">etcd备忘</h1>
                        </header>
                        <date class="post-meta meta-date">
                            2019年3月13日
                        </date>
                        
                        <div class="post-meta">
                            <span>|</span>
                            
                                <span class="meta-category"><a href="http://emacsvi.com/categories/etcd">etcd</a></span>
                            
                        </div>
                        
                        
                        <div class="post-content">
                            

<h2 id="概念">概念</h2>

<p>来自<a href="https://www.ph0en1x.space/2019/01/10/Raft/">raft安全性问题以及投票过程</a>
Raft一共研究的就是三个子问题：</p>

<ul>
<li>如何选举领导者，当现有的领导者失效的情况下，如何选出新的领导者，选举领导者的时候如何确定新的领导者不会破坏安全性原则</li>
<li>如何进行日志的复制，什么时候可以保证日志可以安全提交</li>

<li><p>如何保证系统的安全性，要维护包含以下的几个性质：</p>

<ul>
<li>选举安全性：每一个任期(term)内只能有一个服务器被选举为领导者。</li>
<li>领导者只做append操作：领导者的所有的日志entry只能append在队列尾，而不能删除和覆盖。</li>
<li>日志匹配：如果两个日志在相同的序号上的日志entry的任期相同，那么这个日志从头到这个序号之间的日志entry时完全相同的。</li>
<li>领导者完整性：在一个领导者上提交的日志entry，在后面的term的领导者中也必须出现。也就是说，只有同步了最新log的server才能够被选举为领导者。</li>
<li>状态机安全性：如果一个服务器已经执行了日志上某个entry中的指令，那么其他服务器上相同序号不同的日志entry将不能够执行。</li>
</ul></li>
</ul>

<h2 id="go语言操作">go语言操作</h2>

<h4 id="连接-etcd">连接<code>etcd</code></h4>

<p>要访问etcd第一件事就是创建client，它需要传入一个Config配置，这里传了2个选项:</p>

<ul>
<li>Endpoints：etcd的多个节点服务地址，因为我是单点测试，所以只传1个。</li>
<li>DialTimeout：创建client的首次连接超时，这里传了5秒，如果5秒都没有连接成功就会返回err；值得注意的是，一旦client创建成功，我们就不用再关心后续底层连接的状态了，client内部会重连。</li>
</ul>

<p>当然，如果<code>err != nil</code>，那么一般情况下我们可以选择重试几次，或者退出程序（重启）。</p>

<p>查看client里面有Cluster、KV、Lease…，你会发现它们其实就代表了整个客户端的几大核心功能板块，分别用于：</p>

<ul>
<li>Cluster：向集群里增加etcd服务端节点之类，属于管理员操作。</li>
<li>KV：我们主要使用的功能，即操作K-V。</li>
<li>Lease：租约相关操作，比如申请一个TTL=10秒的租约。</li>
<li>Watcher：观察订阅，从而监听最新的数据变化。</li>
<li>Auth：管理etcd的用户和权限，属于管理员操作。</li>
<li>Maintenance：维护etcd，比如主动迁移etcd的leader节点，属于管理员操作。</li>
</ul>

<p>我们需要使用什么功能，就去获取对应的对象即可。</p>

<pre><code class="language-go">package main

import (
	&quot;fmt&quot;
	&quot;go.etcd.io/etcd/clientv3&quot;
	&quot;time&quot;
)

func main() {
	var (
		config clientv3.Config
		cli *clientv3.Client
		err error
	)

  // Endpoints是一个集群数组
	config = clientv3.Config{
    Endpoints: []string{&quot;127.0.0.1:2379&quot;, &quot;192.168.1.5:2379&quot;},
		DialTimeout: 5 * time.Second,
	}

	if cli, err = clientv3.New(config); err != nil {
		panic(err)
	}

	defer cli.Close()

	fmt.Println(&quot;连接成功。&quot;)
}
</code></pre>

<h4 id="常规的kv-put操作">常规的kv.Put操作</h4>

<pre><code class="language-go">package main

import (
	&quot;context&quot;
	&quot;fmt&quot;
	&quot;go.etcd.io/etcd/clientv3&quot;
	&quot;time&quot;
)

func main() {
	var (
		cfg     clientv3.Config
		client  *clientv3.Client
		err     error
		kv      clientv3.KV
		putResp *clientv3.PutResponse
	)

	cfg = clientv3.Config{
		Endpoints:   []string{&quot;127.0.0.1:2379&quot;},
		DialTimeout: 5 * time.Second,
	}

	if client, err = clientv3.New(cfg); err != nil {
		panic(err)
	}

	defer client.Close()

	kv = clientv3.NewKV(client)

	if putResp, err = kv.Put(context.TODO(), &quot;/cron/jobs/job1&quot;, &quot;bye&quot;, clientv3.WithPrevKV()); err != nil {
		panic(err)
	} else {
		fmt.Println(&quot;Revision:&quot;, putResp.Header.Revision)
		if putResp.PrevKv != nil {
			fmt.Println(&quot;PreValue:&quot;, string(putResp.PrevKv.Value))
		}
	}
}
</code></pre>

<h4 id="常规的get-delete操作">常规的get,delete操作</h4>

<pre><code class="language-go">package main

import (
	&quot;context&quot;
	&quot;fmt&quot;
	&quot;go.etcd.io/etcd/clientv3&quot;
	&quot;go.etcd.io/etcd/mvcc/mvccpb&quot;
	&quot;time&quot;
)

func main() {
	var (
		cfg     clientv3.Config
		cli     *clientv3.Client
		err     error
		kv      clientv3.KV
		getResp *clientv3.GetResponse
		kvPair  *mvccpb.KeyValue
		delResp *clientv3.DeleteResponse
	)

	cfg = clientv3.Config{
		Endpoints:   []string{&quot;127.0.0.1:2379&quot;},
		DialTimeout: 5 * time.Second,
	}

	if cli, err = clientv3.New(cfg); err != nil {
		panic(err)
	}

	defer cli.Close()

	kv = clientv3.NewKV(cli)

	if getResp, err = kv.Get(context.TODO(), &quot;/cron/jobs/job1&quot;); err != nil {
		panic(err)
	} else {
		fmt.Println(getResp.Kvs)
	}

	// put job2
	if _, err = kv.Put(context.TODO(), &quot;/cron/jobs/job2&quot;, &quot;golang&quot;); err != nil {
		panic(err)
	}

	// put job3
	if _, err = kv.Put(context.TODO(), &quot;/cron/jobs/job3&quot;, &quot;java&quot;); err != nil {
		panic(err)
	}

	fmt.Println(&quot;开始查找。。。&quot;)

	// get prefix 查询以/cron/jobs前缀的，也就是这个目录
	if getResp, err = kv.Get(context.TODO(), &quot;/cron/jobs&quot;, clientv3.WithPrefix()); err != nil {
		panic(err)
	} else {
		for _, kvPair = range getResp.Kvs {
			fmt.Println(string(kvPair.Key), &quot;=&quot;, string(kvPair.Value))
		}
	}

	fmt.Println(&quot;开始删除。。。&quot;)

	if delResp, err = kv.Delete(context.TODO(), &quot;/cron/jobs&quot;, clientv3.WithPrefix(), clientv3.WithPrevKV()); err != nil {
		panic(err)
	} else {
		for _, kvPair = range delResp.PrevKvs {
			fmt.Println(string(kvPair.Key), &quot;=&quot;, string(kvPair.Value))
		}
	}
}
</code></pre>

<h4 id="利用kv操作op对象">利用kv操作Op对象</h4>

<pre><code class="language-go">package main

import (
	&quot;context&quot;
	&quot;fmt&quot;
	&quot;go.etcd.io/etcd/clientv3&quot;
	&quot;time&quot;
)

func main() {

	var (
		cfg    clientv3.Config
		cli    *clientv3.Client
		err    error
		kv     clientv3.KV
		commOp clientv3.Op
		opResp clientv3.OpResponse
	)

	cfg = clientv3.Config{
		Endpoints:   []string{&quot;127.0.0.1:2379&quot;},
		DialTimeout: 5 * time.Second,
	}

	if cli, err = clientv3.New(cfg); err != nil {
		panic(err)
	}

	defer cli.Close()

	kv = clientv3.NewKV(cli)

	// 创建op
	commOp = clientv3.OpPut(&quot;/cron/jobs/job8&quot;, &quot;123456&quot;)

	// 执行OP
	if opResp, err = kv.Do(context.TODO(), commOp); err != nil {
		panic(err)
	}

	fmt.Println(&quot;写入Revision:&quot;, opResp.Put().Header.Revision)

	// 创建读op
	commOp = clientv3.OpGet(&quot;/cron/jobs/job8&quot;)
	// 执行读OP
	if opResp, err = kv.Do(context.TODO(), commOp); err != nil {
		panic(err)
	}

	fmt.Println(string(opResp.Get().Kvs[0].Value), &quot; &quot;, opResp.Get().Kvs[0].CreateRevision, opResp.Get().Kvs[0].ModRevision)
}
</code></pre>

<h2 id="参考文献">参考文献</h2>

<ul>
<li><a href="https://yuerblog.cc/2017/12/12/etcd-v3-sdk-usage/">go etcd v3 常用方法</a></li>
</ul>

                        </div>

                        


                        

<div class="post-archive">
    <h2>See Also</h2>
    <ul class="listing">
        
        <li><a href="/post/spf13-vim-3-0-release-and-new-website/">etcd 有关的内容 这只是一个示例 内容随便写</a></li>
        
        <li><a href="/post/go-dep/">dep教程</a></li>
        
        <li><a href="/post/mianshi/">常用的面试题准备</a></li>
        
        <li><a href="/post/TiDB-notes/">TiDB分布式数据库</a></li>
        
        <li><a href="/post/istio-notes/">Istio的使用教程</a></li>
        
    </ul>
</div>


                        <div class="post-meta meta-tags">
                            
                            <ul class="clearfix">
                                
                                <li><a href="http://emacsvi.com/tags/etcd">etcd</a></li>
                                
                                <li><a href="http://emacsvi.com/tags/go">go</a></li>
                                
                            </ul>
                            
                        </div>
                    </article>
                    
    

    
    
                </div>
            </div>
            <div id="secondary">
    <section class="widget">
        <form id="search" action="//www.google.com/search" method="get" accept-charset="utf-8" target="_blank" _lpchecked="1">
      
      <input type="text" name="q" maxlength="20" placeholder="Search">
      <input type="hidden" name="sitesearch" value="http://emacsvi.com">
      <button type="submit" class="submit icon-search"></button>
</form>
    </section>
    
    <section class="widget">
        <h3 class="widget-title">最近文章</h3>
<ul class="widget-list">
    
    <li>
        <a href="http://emacsvi.com/post/kubeadm-kubernetes/" title="利用kubeadm部署kubernetes">利用kubeadm部署kubernetes</a>
    </li>
    
    <li>
        <a href="http://emacsvi.com/post/centos7-system-notes/" title="centos7系统配置">centos7系统配置</a>
    </li>
    
    <li>
        <a href="http://emacsvi.com/post/vagrant-notes/" title="vagrant相关配置命令">vagrant相关配置命令</a>
    </li>
    
    <li>
        <a href="http://emacsvi.com/post/heling-go-36-notes/" title="赫林老师go语言36讲">赫林老师go语言36讲</a>
    </li>
    
    <li>
        <a href="http://emacsvi.com/post/frp/" title="frp内网穿透">frp内网穿透</a>
    </li>
    
    <li>
        <a href="http://emacsvi.com/post/harbor-image-notes/" title="harbor镜像仓库搭建">harbor镜像仓库搭建</a>
    </li>
    
    <li>
        <a href="http://emacsvi.com/post/dynamic-json-in-go/" title="Dynamic Json In Go">Dynamic Json In Go</a>
    </li>
    
    <li>
        <a href="http://emacsvi.com/post/my-go-codes/" title="go常用的一些代码备忘">go常用的一些代码备忘</a>
    </li>
    
    <li>
        <a href="http://emacsvi.com/post/go-keng-notes/" title="go语言编码过程中常见的坑总结">go语言编码过程中常见的坑总结</a>
    </li>
    
    <li>
        <a href="http://emacsvi.com/post/go-websocket-practice/" title="websocket实践">websocket实践</a>
    </li>
    
</ul>
    </section>

    

    <section class="widget">
        <h3 class="widget-title">分类</h3>
<ul class="widget-list">
    
    <li>
        <a href="http://emacsvi.com/categories/blockchain/">blockchain(1)</a>
    </li>
    
    <li>
        <a href="http://emacsvi.com/categories/consul/">consul(1)</a>
    </li>
    
    <li>
        <a href="http://emacsvi.com/categories/db/">db(1)</a>
    </li>
    
    <li>
        <a href="http://emacsvi.com/categories/docker/">docker(2)</a>
    </li>
    
    <li>
        <a href="http://emacsvi.com/categories/etcd/">etcd(1)</a>
    </li>
    
    <li>
        <a href="http://emacsvi.com/categories/ethereum/">ethereum(1)</a>
    </li>
    
    <li>
        <a href="http://emacsvi.com/categories/go/">go(30)</a>
    </li>
    
    <li>
        <a href="http://emacsvi.com/categories/kubernetes/">kubernetes(2)</a>
    </li>
    
    <li>
        <a href="http://emacsvi.com/categories/linux/">linux(4)</a>
    </li>
    
    <li>
        <a href="http://emacsvi.com/categories/mac/">mac(1)</a>
    </li>
    
    <li>
        <a href="http://emacsvi.com/categories/markdown/">markdown(1)</a>
    </li>
    
    <li>
        <a href="http://emacsvi.com/categories/nodejs/">nodejs(1)</a>
    </li>
    
    <li>
        <a href="http://emacsvi.com/categories/python/">python(10)</a>
    </li>
    
    <li>
        <a href="http://emacsvi.com/categories/react/">react(1)</a>
    </li>
    
    <li>
        <a href="http://emacsvi.com/categories/redis/">redis(2)</a>
    </li>
    
    <li>
        <a href="http://emacsvi.com/categories/%E6%8A%80%E6%9C%AF/">技术(1)</a>
    </li>
    
    <li>
        <a href="http://emacsvi.com/categories/%E6%97%85%E8%A1%8C/">旅行(4)</a>
    </li>
    
    <li>
        <a href="http://emacsvi.com/categories/%E6%B5%81%E9%87%91%E5%B2%81%E6%9C%88/">流金岁月(1)</a>
    </li>
    
</ul>
    </section>

    <section class="widget">
        <h3 class="widget-title">标签</h3>
<div class="tagcloud">
    
    <a href="http://emacsvi.com/tags/Istio/">Istio</a>
    
    <a href="http://emacsvi.com/tags/blockchain/">blockchain</a>
    
    <a href="http://emacsvi.com/tags/cmds/">cmds</a>
    
    <a href="http://emacsvi.com/tags/codis/">codis</a>
    
    <a href="http://emacsvi.com/tags/consul/">consul</a>
    
    <a href="http://emacsvi.com/tags/curl/">curl</a>
    
    <a href="http://emacsvi.com/tags/db/">db</a>
    
    <a href="http://emacsvi.com/tags/django/">django</a>
    
    <a href="http://emacsvi.com/tags/docker/">docker</a>
    
    <a href="http://emacsvi.com/tags/docker-compose/">docker-compose</a>
    
    <a href="http://emacsvi.com/tags/etcd/">etcd</a>
    
    <a href="http://emacsvi.com/tags/ethereum/">ethereum</a>
    
    <a href="http://emacsvi.com/tags/go/">go</a>
    
    <a href="http://emacsvi.com/tags/javascript/">javascript</a>
    
    <a href="http://emacsvi.com/tags/kubernetes/">kubernetes</a>
    
    <a href="http://emacsvi.com/tags/linux/">linux</a>
    
    <a href="http://emacsvi.com/tags/mac/">mac</a>
    
    <a href="http://emacsvi.com/tags/markdown/">markdown</a>
    
    <a href="http://emacsvi.com/tags/mongodb/">mongodb</a>
    
    <a href="http://emacsvi.com/tags/mysql/">mysql</a>
    
    <a href="http://emacsvi.com/tags/nodejs/">nodejs</a>
    
    <a href="http://emacsvi.com/tags/python/">python</a>
    
    <a href="http://emacsvi.com/tags/react/">react</a>
    
    <a href="http://emacsvi.com/tags/redis/">redis</a>
    
    <a href="http://emacsvi.com/tags/selenium/">selenium</a>
    
    <a href="http://emacsvi.com/tags/sql/">sql</a>
    
    <a href="http://emacsvi.com/tags/supervisord/">supervisord</a>
    
    <a href="http://emacsvi.com/tags/vagrant/">vagrant</a>
    
    <a href="http://emacsvi.com/tags/websocket/">websocket</a>
    
    <a href="http://emacsvi.com/tags/%E5%A4%87%E5%BF%98/">备忘</a>
    
    <a href="http://emacsvi.com/tags/%E6%8A%80%E6%9C%AF/">技术</a>
    
    <a href="http://emacsvi.com/tags/%E6%97%85%E8%A1%8C/">旅行</a>
    
    <a href="http://emacsvi.com/tags/%E7%88%AC%E8%99%AB/">爬虫</a>
    
</div>
    </section>

    
<section class="widget">
    <h3 class="widget-title">友情链接</h3>
    <ul class="widget-list">
        
        <li>
            <a target="_blank" href="#" title="Android Gradle权威指南">Android Gradle权威指南</a>
        </li>
        
        <li>
            <a target="_blank" href="#" title="常用开发工具CDN镜像">常用开发工具CDN镜像</a>
        </li>
        
    </ul>
</section>


    <section class="widget">
        <h3 class="widget-title">其它</h3>
        <ul class="widget-list">
            <li><a href="http://emacsvi.com/index.xml">文章 RSS</a></li>
        </ul>
    </section>
</div>
        </div>
    </div>
</div>
<footer id="footer">
    <div class="container">
        &copy; 2019 <a href="http://emacsvi.com">李伟的博客 By emacsvi</a>.
        Powered by <a rel="nofollow noreferer noopener" href="https://gohugo.io" target="_blank">Hugo</a>.
        <a href="https://www.emacsvi.com/" target="_blank">Theme</a> based on <a href="https://emacsvi.com" target="_blank">maupassant</a>.
        
    </div>
</footer>


    <script type="text/javascript">
    
    (function(){
        $("pre code").parent().addClass("line-numbers")
    }())

    window.MathJax = {
        tex2jax: {
            inlineMath: [ ['$','$'] ],
            processEscapes: true
        }
    };
    </script>
    <script type="text/javascript" src="/js/prism.js" async="true"></script>
    <script src='https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js?config=TeX-MML-AM_CHTML' async></script>

<a id="rocket" href="#top"></a>
<script type="text/javascript" src="/js/totop.js?v=0.0.0" async=""></script>







</body>
</html>
